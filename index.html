<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GM Campaign Manager Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(-45deg, #0f172a, #1e293b, #334155, #1e293b);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color: #e2e8f0;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 100px;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 20%, rgba(236, 72, 153, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
            animation: float 20s ease-in-out infinite;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.5),
                0 0 100px rgba(59, 130, 246, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 1;
            animation: slideIn 0.6s ease-out;
        }

        header {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%);
            background-size: 200% 200%;
            animation: gradientShift 10s ease infinite;
            padding: 40px;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: float 15s ease-in-out infinite;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 25px;
            position: relative;
            z-index: 1;
        }

        h1 {
            font-size: 2.8em;
            text-shadow: 
                2px 2px 4px rgba(0, 0, 0, 0.3),
                0 0 30px rgba(255, 255, 255, 0.2);
            font-weight: 700;
            letter-spacing: -1px;
            background: linear-gradient(to right, #ffffff, #e0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-tools {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .search-bar {
            display: flex;
            gap: 12px;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .search-input {
            padding: 14px 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            color: white;
            font-size: 1em;
            min-width: 350px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .search-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .tool-btn {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .tool-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .tool-btn:active {
            transform: translateY(-1px);
        }

        .tabs {
            display: flex;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
            border-bottom: 3px solid transparent;
            border-image: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899) 1;
            overflow-x: auto;
            position: relative;
        }

        .tabs::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
            opacity: 0.3;
        }

        .tab-button {
            padding: 18px 28px;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            position: relative;
        }

        .tab-button::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }

        .tab-button:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #e2e8f0;
        }

        .tab-button:hover::before {
            width: 80%;
        }

        .tab-button.active {
            color: #60a5fa;
            background: rgba(59, 130, 246, 0.15);
        }

        .tab-button.active::before {
            width: 100%;
        }

        .tab-content {
            display: none;
            padding: 35px;
            animation: slideIn 0.4s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: rgba(51, 65, 85, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .section:hover {
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        h2 {
            color: #60a5fa;
            font-size: 2em;
            margin-bottom: 12px;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h3 {
            color: #93c5fd;
            margin-bottom: 18px;
            font-weight: 600;
        }

        button {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:hover::before {
            width: 300px;
            height: 300px;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.6);
        }

        button:active {
            transform: translateY(-1px);
        }

        button.delete-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            padding: 10px 20px;
            font-size: 0.95em;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        button.delete-btn:hover {
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.6);
        }

        button.secondary-btn {
            background: linear-gradient(135deg, #64748b, #475569);
            box-shadow: 0 4px 15px rgba(100, 116, 139, 0.4);
        }

        button.secondary-btn:hover {
            box-shadow: 0 8px 25px rgba(100, 116, 139, 0.6);
        }

        input, textarea, select {
            width: 100%;
            padding: 14px;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(71, 85, 105, 0.5);
            border-radius: 10px;
            color: #e2e8f0;
            font-size: 1em;
            margin-bottom: 18px;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.2),
                0 0 0 3px rgba(59, 130, 246, 0.2);
            background: rgba(15, 23, 42, 0.8);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #cbd5e1;
            font-weight: 600;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .character-card, .plot-card, .session-card, .location-card, .item-card, .media-card {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 14px;
            padding: 24px;
            margin-bottom: 20px;
            border-left: 5px solid #3b82f6;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .character-card:hover, .plot-card:hover, .session-card:hover, 
        .location-card:hover, .item-card:hover, .media-card:hover {
            transform: translateX(8px) translateY(-2px);
            box-shadow: 0 8px 30px rgba(59, 130, 246, 0.3);
            border-left-width: 7px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 18px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .card-image {
            width: 130px;
            height: 130px;
            object-fit: cover;
            border-radius: 12px;
            margin-right: 20px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .card-image:hover {
            transform: scale(1.05);
            border-color: rgba(59, 130, 246, 0.6);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .card-info {
            flex: 1;
        }

        .card-name {
            font-size: 1.6em;
            color: #60a5fa;
            margin-bottom: 8px;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(96, 165, 250, 0.3);
        }

        .card-type {
            color: #94a3b8;
            font-size: 0.95em;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
            margin: 18px 0;
            padding: 20px;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(5px);
            border-radius: 8px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .stat-label {
            font-weight: 600;
            color: #94a3b8;
        }

        .stat-value {
            color: #60a5fa;
            font-weight: 700;
            font-size: 1.1em;
        }

        .notes {
            color: #cbd5e1;
            line-height: 1.7;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(71, 85, 105, 0.5);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 1000;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: rgba(51, 65, 85, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 35px;
            max-width: 850px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.6),
                0 0 100px rgba(59, 130, 246, 0.2);
            animation: slideIn 0.4s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .close-btn {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            font-size: 2em;
            padding: 0;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid rgba(239, 68, 68, 0.3);
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            transform: rotate(90deg);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .image-preview {
            max-width: 220px;
            max-height: 220px;
            border-radius: 12px;
            margin-top: 12px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 5em;
            margin-bottom: 25px;
            opacity: 0.4;
            animation: float 3s ease-in-out infinite;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* Dice Roller Widget */
        .dice-roller {
            position: fixed;
            bottom: 120px;
            right: 25px;
            background: rgba(51, 65, 85, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 
                0 10px 40px rgba(0, 0, 0, 0.5),
                0 0 60px rgba(59, 130, 246, 0.2);
            z-index: 100;
            min-width: 300px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideIn 0.5s ease-out;
        }

        .dice-roller.minimized {
            padding: 12px;
            min-width: auto;
        }

        .dice-roller.minimized .dice-content {
            display: none;
        }

        .dice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .dice-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 18px;
        }

        .dice-btn {
            padding: 12px;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
            border: 2px solid #3b82f6;
            color: #3b82f6;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .dice-btn:hover {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .dice-btn:active {
            transform: scale(0.95);
        }

        .dice-result {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            padding: 18px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.3em;
            color: #60a5fa;
            font-weight: 700;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(59, 130, 246, 0.3);
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .custom-roll {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .custom-roll input {
            margin: 0;
            flex: 1;
        }

        /* Quick Notes */
        .quick-notes {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(51, 65, 85, 0.95);
            backdrop-filter: blur(20px);
            border-top: 3px solid transparent;
            border-image: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899) 1;
            z-index: 99;
            transition: all 0.3s ease;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
        }

        .quick-notes.minimized .notes-content {
            display: none;
        }

        .notes-header {
            padding: 14px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background: rgba(15, 23, 42, 0.8);
            transition: all 0.3s ease;
        }

        .notes-header:hover {
            background: rgba(15, 23, 42, 0.95);
        }

        .notes-content {
            padding: 25px;
        }

        .notes-content textarea {
            min-height: 100px;
            margin-bottom: 12px;
        }

        /* Combat Tracker */
        .combatant-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .combatant-item {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid #3b82f6;
            flex-wrap: wrap;
            gap: 15px;
            transition: all 0.3s ease;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .combatant-item:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.3);
        }

        .combatant-item.active {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.15);
            box-shadow: 0 8px 30px rgba(16, 185, 129, 0.3);
            animation: pulse 2s ease-in-out infinite;
        }

        .combatant-info {
            flex: 1;
            min-width: 280px;
        }

        .combatant-name {
            font-size: 1.3em;
            color: #60a5fa;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .combatant-stats {
            display: flex;
            gap: 18px;
            color: #94a3b8;
            font-size: 0.95em;
            flex-wrap: wrap;
            font-weight: 500;
        }

        .hp-bar {
            width: 220px;
            height: 24px;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 12px;
            overflow: hidden;
            margin-top: 8px;
            border: 2px solid rgba(59, 130, 246, 0.3);
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399, #6ee7b7);
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        /* Timeline */
        .timeline-container {
            position: relative;
            padding-left: 35px;
        }

        .timeline-item {
            position: relative;
            padding: 24px;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 5px solid #3b82f6;
            transition: all 0.3s ease;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .timeline-item:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.3);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -42px;
            top: 28px;
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-radius: 50%;
            border: 4px solid rgba(51, 65, 85, 0.9);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.6);
            animation: pulse 2s ease-in-out infinite;
        }

        .timeline-date {
            color: #60a5fa;
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 1.05em;
        }

        .timeline-event {
            font-size: 1.15em;
            margin-bottom: 8px;
            font-weight: 600;
        }

        /* Media Gallery */
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .media-item {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 14px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s ease;
            border: 1px solid rgba(59, 130, 246, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .media-item:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 12px 40px rgba(59, 130, 246, 0.4);
            border-color: rgba(59, 130, 246, 0.5);
        }

        .media-thumbnail {
            width: 100%;
            height: 220px;
            object-fit: cover;
            transition: all 0.4s ease;
        }

        .media-item:hover .media-thumbnail {
            transform: scale(1.1);
        }

        .media-info {
            padding: 18px;
            background: rgba(30, 41, 59, 0.8);
        }

        .media-name {
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 8px;
            font-size: 1.05em;
        }

        .media-category {
            color: #94a3b8;
            font-size: 0.9em;
            font-weight: 500;
        }

        .fullscreen-viewer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.97);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .fullscreen-viewer.active {
            display: flex;
        }

        .fullscreen-content {
            max-width: 95vw;
            max-height: 95vh;
            animation: slideIn 0.4s ease-out;
        }

        .fullscreen-content img, .fullscreen-content video {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 12px;
            box-shadow: 0 20px 80px rgba(0, 0, 0, 0.8);
        }

        .fullscreen-close {
            position: absolute;
            top: 25px;
            right: 25px;
            font-size: 3em;
            color: white;
            cursor: pointer;
            background: rgba(239, 68, 68, 0.3);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .fullscreen-close:hover {
            background: rgba(239, 68, 68, 0.6);
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 10px 40px rgba(239, 68, 68, 0.6);
        }

        /* Relationships */
        .relationships {
            margin-top: 18px;
            padding-top: 18px;
            border-top: 1px solid rgba(71, 85, 105, 0.5);
        }

        .relationship-tag {
            display: inline-block;
            background: rgba(59, 130, 246, 0.15);
            padding: 6px 14px;
            border-radius: 20px;
            margin: 6px;
            font-size: 0.9em;
            border: 1px solid rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }

        .relationship-tag:hover {
            background: rgba(59, 130, 246, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* Media Gallery Help Banner */
        .help-banner {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .help-banner h3 {
            color: white;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .help-banner p {
            color: rgba(255, 255, 255, 0.9);
            margin: 0;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .card-image {
                width: 100px;
                height: 100px;
            }
            
            h1 {
                font-size: 2em;
            }

            .search-input {
                min-width: 200px;
            }

            .dice-roller {
                right: 15px;
                bottom: 110px;
                min-width: 270px;
            }

            .header-tools {
                width: 100%;
            }

            .search-bar {
                width: 100%;
            }

            .search-input {
                width: 100%;
            }

            .media-grid {
                grid-template-columns: 1fr;
            }
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
        }

        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }

        small {
            font-size: 0.85em;
            color: #94a3b8;
        }

        .settings-icon {
            font-size: 1.2em;
            animation: float 3s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <h1>⚔️ GM Campaign Manager Pro</h1>
                <div class="header-tools">
                    <button class="tool-btn" onclick="openRandomGenerator()">🎲 Random Gen</button>
                    <button class="tool-btn" onclick="exportData()">💾 Export</button>
                    <button class="tool-btn" onclick="document.getElementById('import-file').click()">📂 Import</button>
                    <button class="tool-btn" onclick="openSettings()" title="Settings"><span class="settings-icon">⚙️</span></button>
                    <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(this)">
                </div>
            </div>
            <div class="search-bar">
                <input type="text" class="search-input" id="global-search" placeholder="🔍 Search everything..." oninput="performSearch()">
                <button class="tool-btn" onclick="clearSearch()">Clear</button>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-button active" data-tab="campaign">📜 Campaign</button>
            <button class="tab-button" data-tab="characters">👥 Characters</button>
            <button class="tab-button" data-tab="plots">📖 Plots</button>
            <button class="tab-button" data-tab="sessions">🎲 Sessions</button>
            <button class="tab-button" data-tab="locations">🗺️ Locations</button>
            <button class="tab-button" data-tab="items">⚔️ Items</button>
            <button class="tab-button" data-tab="combat">⚔️ Combat</button>
            <button class="tab-button" data-tab="timeline">📅 Timeline</button>
            <button class="tab-button" data-tab="media">🖼️ Show Players</button>
        </div>

        <!-- Campaign Info Tab -->
        <div id="campaign" class="tab-content active">
            <div class="section">
                <h2>Campaign Information</h2>
                <div class="form-group">
                    <label>Campaign Name</label>
                    <input type="text" id="campaign-name" placeholder="Enter campaign name">
                </div>
                <div class="form-group">
                    <label>Game System</label>
                    <input type="text" id="game-system" placeholder="D&D 5e, Pathfinder, etc.">
                </div>
                <div class="form-group">
                    <label>Setting</label>
                    <textarea id="campaign-setting" placeholder="Describe your campaign setting..."></textarea>
                </div>
                <div class="form-group">
                    <label>Campaign Overview</label>
                    <textarea id="campaign-overview" placeholder="General campaign notes and overview..."></textarea>
                </div>
                <button onclick="saveCampaignInfo()">💾 Save Campaign Info</button>
            </div>
        </div>

        <!-- Characters Tab -->
        <div id="characters" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2>Characters & NPCs</h2>
                    <button onclick="openCharacterModal()">➕ Add Character</button>
                </div>
                <div id="characters-list"></div>
            </div>
        </div>

        <!-- Plots Tab -->
        <div id="plots" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2>Main Plots & Story Arcs</h2>
                    <button onclick="openPlotModal()">➕ Add Plot</button>
                </div>
                <div id="plots-list"></div>
            </div>
        </div>

        <!-- Sessions Tab -->
        <div id="sessions" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2>Session Notes</h2>
                    <button onclick="openSessionModal()">➕ Add Session</button>
                </div>
                <div id="sessions-list"></div>
            </div>
        </div>

        <!-- Locations Tab -->
        <div id="locations" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2>Locations</h2>
                    <button onclick="openLocationModal()">➕ Add Location</button>
                </div>
                <div id="locations-list"></div>
            </div>
        </div>

        <!-- Items Tab -->
        <div id="items" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2>Items & Loot</h2>
                    <button onclick="openItemModal()">➕ Add Item</button>
                </div>
                <div id="items-list"></div>
            </div>
        </div>

        <!-- Combat Tracker Tab -->
        <div id="combat" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2>Combat Tracker</h2>
                    <div class="btn-group">
                        <button onclick="openCombatantModal()">➕ Add Combatant</button>
                        <button onclick="nextTurn()" style="background: linear-gradient(135deg, #10b981, #34d399);">▶️ Next Turn</button>
                        <button onclick="clearCombat()" class="delete-btn">Clear Combat</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Round: <span id="combat-round" style="color: #60a5fa; font-size: 1.2em;">1</span></label>
                </div>
                <div id="combat-list"></div>
            </div>
        </div>

        <!-- Timeline Tab -->
        <div id="timeline" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2>Campaign Timeline</h2>
                    <button onclick="openTimelineModal()">➕ Add Event</button>
                </div>
                <div class="timeline-container" id="timeline-list"></div>
            </div>
        </div>

        <!-- Media Gallery Tab -->
        <div id="media" class="tab-content">
            <div class="help-banner">
                <h3>📸 Show Your Players!</h3>
                <p>Upload maps, character art, scenery, and videos to share during sessions. Click any image to show it fullscreen to your players!</p>
            </div>
            <div class="section">
                <div class="section-header">
                    <h2>Media Gallery</h2>
                    <button onclick="openMediaModal()">➕ Add Media</button>
                </div>
                <div class="media-grid" id="media-list"></div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>⚙️ Settings</h2>
                <button class="close-btn" onclick="closeSettings()">×</button>
            </div>
            <div class="section">
                <h3>⚠️ Danger Zone</h3>
                <p style="color: #94a3b8; margin-bottom: 20px;">This action cannot be undone. Make sure to export your data first!</p>
                <button onclick="deleteAllData()" class="delete-btn" style="font-size: 1.1em; padding: 16px 32px;">
                    🗑️ Delete All Campaign Data
                </button>
            </div>
        </div>
    </div>

    <!-- Character Modal (same as before, just prettier styling applies) -->
    <div id="character-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add/Edit Character</h2>
                <button class="close-btn" onclick="closeCharacterModal()">×</button>
            </div>
            <div class="form-group">
                <label>Character Name *</label>
                <input type="text" id="char-name" required>
            </div>
            <div class="form-group">
                <label>Type</label>
                <select id="char-type">
                    <option value="PC">Player Character</option>
                    <option value="NPC">Non-Player Character</option>
                    <option value="Enemy">Enemy/Antagonist</option>
                    <option value="Ally">Ally</option>
                </select>
            </div>
            <div class="form-group">
                <label>Character Image</label>
                <input type="file" id="char-image" accept="image/*" onchange="previewImage(this, 'char-image-preview')">
                <img id="char-image-preview" class="image-preview" style="display:none;">
            </div>
            <div class="form-group">
                <label>Stats (JSON format for combat tracker integration)</label>
                <textarea id="char-stats" placeholder='{"HP": 45, "AC": 16, "STR": 14, "DEX": 12, "Initiative": 2}'></textarea>
                <small>💡 Use JSON format for best combat tracker integration!</small>
            </div>
            <div class="form-group">
                <label>Notes & Description</label>
                <textarea id="char-notes" placeholder="Character background, personality, goals, etc."></textarea>
            </div>
            <div class="form-group">
                <label>Relationships</label>
                <textarea id="char-relationships" placeholder="Allied with X, Enemy of Y, etc."></textarea>
            </div>
            <div class="btn-group">
                <button onclick="saveCharacter()">💾 Save Character</button>
                <button onclick="closeCharacterModal()" class="secondary-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Plot Modal -->
    <div id="plot-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add/Edit Plot</h2>
                <button class="close-btn" onclick="closePlotModal()">×</button>
            </div>
            <div class="form-group">
                <label>Plot Title *</label>
                <input type="text" id="plot-title" required>
            </div>
            <div class="two-column">
                <div class="form-group">
                    <label>Type</label>
                    <select id="plot-type">
                        <option value="Main">Main Plot</option>
                        <option value="Subplot">Subplot</option>
                        <option value="Side Quest">Side Quest</option>
                        <option value="Arc">Story Arc</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="plot-status">
                        <option value="Active">Active</option>
                        <option value="Pending">Pending</option>
                        <option value="Completed">Completed</option>
                        <option value="Abandoned">Abandoned</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="plot-description" placeholder="Plot details, objectives, key events..."></textarea>
            </div>
            <div class="form-group">
                <label>Related Characters</label>
                <input type="text" id="plot-characters" placeholder="Character names involved in this plot">
            </div>
            <div class="btn-group">
                <button onclick="savePlot()">💾 Save Plot</button>
                <button onclick="closePlotModal()" class="secondary-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Session Modal -->
    <div id="session-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add/Edit Session</h2>
                <button class="close-btn" onclick="closeSessionModal()">×</button>
            </div>
            <div class="two-column">
                <div class="form-group">
                    <label>Session Number</label>
                    <input type="number" id="session-number" min="1">
                </div>
                <div class="form-group">
                    <label>Session Date</label>
                    <input type="date" id="session-date">
                </div>
            </div>
            <div class="form-group">
                <label>Session Title</label>
                <input type="text" id="session-title" placeholder="Enter session title">
            </div>
            <div class="form-group">
                <label>Session Notes</label>
                <textarea id="session-notes" placeholder="What happened this session..."></textarea>
            </div>
            <div class="btn-group">
                <button onclick="saveSession()">💾 Save Session</button>
                <button onclick="closeSessionModal()" class="secondary-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Location Modal -->
    <div id="location-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add/Edit Location</h2>
                <button class="close-btn" onclick="closeLocationModal()">×</button>
            </div>
            <div class="form-group">
                <label>Location Name *</label>
                <input type="text" id="location-name" required>
            </div>
            <div class="form-group">
                <label>Location Type</label>
                <select id="location-type">
                    <option value="City">City</option>
                    <option value="Dungeon">Dungeon</option>
                    <option value="Tavern">Tavern</option>
                    <option value="Wilderness">Wilderness</option>
                    <option value="Building">Building</option>
                    <option value="Region">Region</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Location Image/Map</label>
                <input type="file" id="location-image" accept="image/*" onchange="previewImage(this, 'location-image-preview')">
                <img id="location-image-preview" class="image-preview" style="display:none;">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="location-description" placeholder="Describe this location..."></textarea>
            </div>
            <div class="form-group">
                <label>Notable NPCs/Features</label>
                <textarea id="location-notes" placeholder="Who's here? What's important?"></textarea>
            </div>
            <div class="btn-group">
                <button onclick="saveLocation()">💾 Save Location</button>
                <button onclick="closeLocationModal()" class="secondary-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Item Modal -->
    <div id="item-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add/Edit Item</h2>
                <button class="close-btn" onclick="closeItemModal()">×</button>
            </div>
            <div class="form-group">
                <label>Item Name *</label>
                <input type="text" id="item-name" required>
            </div>
            <div class="two-column">
                <div class="form-group">
                    <label>Type</label>
                    <select id="item-type">
                        <option value="Weapon">Weapon</option>
                        <option value="Armor">Armor</option>
                        <option value="Magic Item">Magic Item</option>
                        <option value="Potion">Potion</option>
                        <option value="Quest Item">Quest Item</option>
                        <option value="Treasure">Treasure</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Owner/Location</label>
                    <input type="text" id="item-owner" placeholder="Who has it?">
                </div>
            </div>
            <div class="form-group">
                <label>Item Image</label>
                <input type="file" id="item-image" accept="image/*" onchange="previewImage(this, 'item-image-preview')">
                <img id="item-image-preview" class="image-preview" style="display:none;">
            </div>
            <div class="form-group">
                <label>Description & Properties</label>
                <textarea id="item-description" placeholder="What does it do? Special properties?"></textarea>
            </div>
            <div class="btn-group">
                <button onclick="saveItem()">💾 Save Item</button>
                <button onclick="closeItemModal()" class="secondary-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Combatant Modal -->
    <div id="combatant-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Combatant</h2>
                <button class="close-btn" onclick="closeCombatantModal()">×</button>
            </div>
            <div class="form-group">
                <label>Load from Character</label>
                <select id="combatant-character" onchange="loadCharacterStats()">
                    <option value="">-- Manual Entry --</option>
                </select>
                <small>💡 Select a character to auto-fill their stats!</small>
            </div>
            <div class="form-group">
                <label>Name *</label>
                <input type="text" id="combatant-name" required>
            </div>
            <div class="two-column">
                <div class="form-group">
                    <label>Initiative</label>
                    <input type="number" id="combatant-initiative" value="0">
                </div>
                <div class="form-group">
                    <label>HP</label>
                    <input type="number" id="combatant-hp" value="10">
                </div>
            </div>
            <div class="two-column">
                <div class="form-group">
                    <label>Max HP</label>
                    <input type="number" id="combatant-max-hp" value="10">
                </div>
                <div class="form-group">
                    <label>AC</label>
                    <input type="number" id="combatant-ac" value="10">
                </div>
            </div>
            <div class="form-group">
                <label>Conditions/Notes</label>
                <input type="text" id="combatant-conditions" placeholder="Poisoned, Blessed, etc.">
            </div>
            <div class="btn-group">
                <button onclick="saveCombatant()">➕ Add to Combat</button>
                <button onclick="closeCombatantModal()" class="secondary-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Timeline Modal -->
    <div id="timeline-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Timeline Event</h2>
                <button class="close-btn" onclick="closeTimelineModal()">×</button>
            </div>
            <div class="form-group">
                <label>Date/Session</label>
                <input type="text" id="timeline-date" placeholder="Session 5, Day 23, etc.">
            </div>
            <div class="form-group">
                <label>Event Title *</label>
                <input type="text" id="timeline-event" required>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="timeline-description" placeholder="What happened?"></textarea>
            </div>
            <div class="btn-group">
                <button onclick="saveTimelineEvent()">💾 Save Event</button>
                <button onclick="closeTimelineModal()" class="secondary-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Media Modal -->
    <div id="media-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Media</h2>
                <button class="close-btn" onclick="closeMediaModal()">×</button>
            </div>
            <div class="form-group">
                <label>Media Name</label>
                <input type="text" id="media-name" placeholder="Name this media">
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="media-category">
                    <option value="Map">Map</option>
                    <option value="Character Art">Character Art</option>
                    <option value="Scenery">Scenery</option>
                    <option value="Handout">Handout</option>
                    <option value="Music/Sound">Music/Sound</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Upload Image/Video</label>
                <input type="file" id="media-file" accept="image/*,video/*" onchange="previewMedia(this)">
                <div id="media-preview" style="margin-top: 10px;"></div>
                <small>⚠️ Large videos may slow down the app</small>
            </div>
            <div class="form-group">
                <label>OR YouTube URL</label>
                <input type="text" id="media-youtube" placeholder="https://www.youtube.com/watch?v=...">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="media-description" placeholder="Notes about this media"></textarea>
            </div>
            <div class="btn-group">
                <button onclick="saveMedia()">💾 Save Media</button>
                <button onclick="closeMediaModal()" class="secondary-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Random Generator Modal -->
    <div id="random-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Random Generators</h2>
                <button class="close-btn" onclick="closeRandomModal()">×</button>
            </div>
            <div class="section">
                <h3>🧙 NPC Name Generator</h3>
                <div class="btn-group">
                    <button onclick="generateRandom('name')">Generate Name</button>
                </div>
                <div id="random-name-result" style="margin-top: 15px; padding: 20px; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); border-radius: 10px; min-height: 60px; color: #60a5fa; font-size: 1.3em; font-weight: 700; text-align: center; border: 2px solid rgba(59, 130, 246, 0.3);"></div>
            </div>
            <div class="section">
                <h3>🍺 Tavern Name Generator</h3>
                <div class="btn-group">
                    <button onclick="generateRandom('tavern')">Generate Tavern</button>
                </div>
                <div id="random-tavern-result" style="margin-top: 15px; padding: 20px; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); border-radius: 10px; min-height: 60px; color: #60a5fa; font-size: 1.3em; font-weight: 700; text-align: center; border: 2px solid rgba(59, 130, 246, 0.3);"></div>
            </div>
            <div class="section">
                <h3>⚔️ Encounter Idea Generator</h3>
                <div class="btn-group">
                    <button onclick="generateRandom('encounter')">Generate Encounter</button>
                </div>
                <div id="random-encounter-result" style="margin-top: 15px; padding: 20px; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); border-radius: 10px; min-height: 60px; color: #60a5fa; font-size: 1.15em; font-weight: 600; border: 2px solid rgba(59, 130, 246, 0.3);"></div>
            </div>
        </div>
    </div>

    <!-- Fullscreen Media Viewer -->
    <div id="fullscreen-viewer" class="fullscreen-viewer">
        <div class="fullscreen-close" onclick="closeFullscreen()">×</div>
        <div id="fullscreen-content" class="fullscreen-content"></div>
    </div>

    <!-- Dice Roller Widget -->
    <div id="dice-roller" class="dice-roller">
        <div class="dice-header">
            <h3>🎲 Dice Roller</h3>
            <button class="close-btn" onclick="toggleDiceRoller()" style="font-size: 1.5em; width: 35px; height: 35px; background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.3);">−</button>
        </div>
        <div class="dice-content">
            <div class="dice-buttons">
                <button class="dice-btn" onclick="rollDice(4)">d4</button>
                <button class="dice-btn" onclick="rollDice(6)">d6</button>
                <button class="dice-btn" onclick="rollDice(8)">d8</button>
                <button class="dice-btn" onclick="rollDice(10)">d10</button>
                <button class="dice-btn" onclick="rollDice(12)">d12</button>
                <button class="dice-btn" onclick="rollDice(20)">d20</button>
                <button class="dice-btn" onclick="rollDice(100)">d100</button>
            </div>
            <div class="custom-roll">
                <input type="text" id="custom-dice" placeholder="2d6+3" style="margin: 0;">
                <button onclick="rollCustomDice()" style="padding: 12px;">Roll</button>
            </div>
            <div class="dice-result" id="dice-result">Roll some dice!</div>
        </div>
    </div>

    <!-- Quick Notes Widget -->
    <div id="quick-notes" class="quick-notes">
        <div class="notes-header" onclick="toggleQuickNotes()">
            <h3>📝 Quick Notes</h3>
            <span id="notes-toggle" style="font-size: 1.5em; font-weight: bold;">▼</span>
        </div>
        <div class="notes-content">
            <textarea id="quick-notes-text" placeholder="Quick notes during session..." oninput="saveQuickNotes()"></textarea>
        </div>
    </div>

    <script>
        // Data storage
        let campaignData = {
            info: {},
            characters: [],
            plots: [],
            sessions: [],
            locations: [],
            items: [],
            combatants: [],
            timeline: [],
            media: [],
            quickNotes: '',
            combatRound: 1,
            currentTurn: 0
        };

        let editingIndex = null;
        let editingType = null;

        // Load data on startup
        window.onload = function() {
            loadData();
            renderAll();
            loadQuickNotes();
        };

        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.dataset.tab;
                
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                button.classList.add('active');
                document.getElementById(tabName).classList.add('active');
            });
        });

        // Load/Save data
        function loadData() {
            const saved = localStorage.getItem('gmCampaignDataPro');
            if (saved) {
                campaignData = JSON.parse(saved);
                loadCampaignInfo();
            }
        }

        function saveData() {
            localStorage.setItem('gmCampaignDataPro', JSON.stringify(campaignData));
        }

        // Settings
        function openSettings() {
            document.getElementById('settings-modal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        function deleteAllData() {
            if (confirm('⚠️ Are you ABSOLUTELY SURE you want to delete ALL campaign data? This cannot be undone!')) {
                if (confirm('🚨 FINAL WARNING: This will permanently delete everything. Have you exported your data as a backup?')) {
                    localStorage.removeItem('gmCampaignDataPro');
                    campaignData = {
                        info: {},
                        characters: [],
                        plots: [],
                        sessions: [],
                        locations: [],
                        items: [],
                        combatants: [],
                        timeline: [],
                        media: [],
                        quickNotes: '',
                        combatRound: 1,
                        currentTurn: 0
                    };
                    renderAll();
                    loadCampaignInfo();
                    loadQuickNotes();
                    closeSettings();
                    alert('✅ All campaign data has been deleted.');
                }
            }
        }

        // Export/Import
        function exportData() {
            const dataStr = JSON.stringify(campaignData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `campaign-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            alert('Campaign data exported successfully!');
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    campaignData = JSON.parse(e.target.result);
                    saveData();
                    renderAll();
                    loadCampaignInfo();
                    loadQuickNotes();
                    alert('Campaign data imported successfully!');
                } catch (err) {
                    alert('Error importing data: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        // Search
        function performSearch() {
            const query = document.getElementById('global-search').value.toLowerCase();
            if (!query) {
                renderAll();
                return;
            }

            // Search characters
            const filteredChars = campaignData.characters.filter(c => 
                c.name.toLowerCase().includes(query) || 
                (c.notes && c.notes.toLowerCase().includes(query)) ||
                (c.stats && c.stats.toLowerCase().includes(query))
            );

            // Search plots
            const filteredPlots = campaignData.plots.filter(p =>
                p.title.toLowerCase().includes(query) ||
                (p.description && p.description.toLowerCase().includes(query))
            );

            // Search locations
            const filteredLocations = campaignData.locations.filter(l =>
                l.name.toLowerCase().includes(query) ||
                (l.description && l.description.toLowerCase().includes(query))
            );

            // Search items
            const filteredItems = campaignData.items.filter(i =>
                i.name.toLowerCase().includes(query) ||
                (i.description && i.description.toLowerCase().includes(query))
            );

            // Render filtered results
            renderCharacters(filteredChars);
            renderPlots(filteredPlots);
            renderLocations(filteredLocations);
            renderItems(filteredItems);
        }

        function clearSearch() {
            document.getElementById('global-search').value = '';
            renderAll();
        }

        // Campaign Info
        function loadCampaignInfo() {
            document.getElementById('campaign-name').value = campaignData.info.name || '';
            document.getElementById('game-system').value = campaignData.info.system || '';
            document.getElementById('campaign-setting').value = campaignData.info.setting || '';
            document.getElementById('campaign-overview').value = campaignData.info.overview || '';
        }

        function saveCampaignInfo() {
            campaignData.info = {
                name: document.getElementById('campaign-name').value,
                system: document.getElementById('game-system').value,
                setting: document.getElementById('campaign-setting').value,
                overview: document.getElementById('campaign-overview').value
            };
            saveData();
            alert('Campaign information saved!');
        }

        // Characters
        function openCharacterModal(index = null) {
            editingIndex = index;
            editingType = 'character';
            const modal = document.getElementById('character-modal');
            
            if (index !== null) {
                const char = campaignData.characters[index];
                document.getElementById('char-name').value = char.name;
                document.getElementById('char-type').value = char.type;
                document.getElementById('char-stats').value = char.stats;
                document.getElementById('char-notes').value = char.notes;
                document.getElementById('char-relationships').value = char.relationships || '';
                
                if (char.image) {
                    document.getElementById('char-image-preview').src = char.image;
                    document.getElementById('char-image-preview').style.display = 'block';
                }
            } else {
                document.getElementById('char-name').value = '';
                document.getElementById('char-type').value = 'PC';
                document.getElementById('char-stats').value = '';
                document.getElementById('char-notes').value = '';
                document.getElementById('char-relationships').value = '';
                document.getElementById('char-image').value = '';
                document.getElementById('char-image-preview').style.display = 'none';
            }
            
            modal.classList.add('active');
        }

        function closeCharacterModal() {
            document.getElementById('character-modal').classList.remove('active');
            editingIndex = null;
        }

        function saveCharacter() {
            const name = document.getElementById('char-name').value;
            if (!name) {
                alert('Please enter a character name');
                return;
            }

            const character = {
                name: name,
                type: document.getElementById('char-type').value,
                stats: document.getElementById('char-stats').value,
                notes: document.getElementById('char-notes').value,
                relationships: document.getElementById('char-relationships').value,
                image: document.getElementById('char-image-preview').src || null
            };

            if (editingIndex !== null) {
                campaignData.characters[editingIndex] = character;
            } else {
                campaignData.characters.push(character);
            }

            saveData();
            renderCharacters();
            updateCombatantDropdown();
            closeCharacterModal();
        }

        function deleteCharacter(index) {
            if (confirm('Are you sure you want to delete this character?')) {
                campaignData.characters.splice(index, 1);
                saveData();
                renderCharacters();
                updateCombatantDropdown();
            }
        }

        function renderCharacters(chars = null) {
            const container = document.getElementById('characters-list');
            const list = chars || campaignData.characters;
            
            if (list.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">👥</div>
                        <h3>No Characters Yet</h3>
                        <p>Add your first character to get started!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = list.map((char, index) => {
                const actualIndex = campaignData.characters.indexOf(char);
                let statsHtml = '';
                try {
                    const statsObj = JSON.parse(char.stats);
                    statsHtml = '<div class="stats-grid">' + 
                        Object.entries(statsObj).map(([key, value]) => 
                            `<div class="stat-item"><span class="stat-label">${key}:</span><span class="stat-value">${value}</span></div>`
                        ).join('') + 
                        '</div>';
                } catch (e) {
                    if (char.stats) {
                        statsHtml = `<div class="notes"><strong>Stats:</strong><br>${char.stats}</div>`;
                    }
                }

                return `
                    <div class="character-card">
                        <div class="card-header">
                            <div style="display: flex; align-items: flex-start;">
                                ${char.image ? `<img src="${char.image}" class="card-image" alt="${char.name}">` : ''}
                                <div class="card-info">
                                    <div class="card-name">${char.name}</div>
                                    <div class="card-type">${char.type}</div>
                                </div>
                            </div>
                            <div class="btn-group">
                                <button onclick="openCharacterModal(${actualIndex})" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">✏️ Edit</button>
                                <button onclick="deleteCharacter(${actualIndex})" class="delete-btn">🗑️ Delete</button>
                            </div>
                        </div>
                        ${statsHtml}
                        ${char.notes ? `<div class="notes">${char.notes.replace(/\n/g, '<br>')}</div>` : ''}
                        ${char.relationships ? `<div class="relationships"><strong>Relationships:</strong> ${char.relationships}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Plots
        function openPlotModal(index = null) {
            editingIndex = index;
            editingType = 'plot';
            const modal = document.getElementById('plot-modal');
            
            if (index !== null) {
                const plot = campaignData.plots[index];
                document.getElementById('plot-title').value = plot.title;
                document.getElementById('plot-type').value = plot.type;
                document.getElementById('plot-status').value = plot.status;
                document.getElementById('plot-description').value = plot.description;
                document.getElementById('plot-characters').value = plot.characters || '';
            } else {
                document.getElementById('plot-title').value = '';
                document.getElementById('plot-type').value = 'Main';
                document.getElementById('plot-status').value = 'Active';
                document.getElementById('plot-description').value = '';
                document.getElementById('plot-characters').value = '';
            }
            
            modal.classList.add('active');
        }

        function closePlotModal() {
            document.getElementById('plot-modal').classList.remove('active');
            editingIndex = null;
        }

        function savePlot() {
            const title = document.getElementById('plot-title').value;
            if (!title) {
                alert('Please enter a plot title');
                return;
            }

            const plot = {
                title: title,
                type: document.getElementById('plot-type').value,
                status: document.getElementById('plot-status').value,
                description: document.getElementById('plot-description').value,
                characters: document.getElementById('plot-characters').value
            };

            if (editingIndex !== null) {
                campaignData.plots[editingIndex] = plot;
            } else {
                campaignData.plots.push(plot);
            }

            saveData();
            renderPlots();
            closePlotModal();
        }

        function deletePlot(index) {
            if (confirm('Are you sure you want to delete this plot?')) {
                campaignData.plots.splice(index, 1);
                saveData();
                renderPlots();
            }
        }

        function renderPlots(plots = null) {
            const container = document.getElementById('plots-list');
            const list = plots || campaignData.plots;
            
            if (list.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📖</div>
                        <h3>No Plots Yet</h3>
                        <p>Add your first plot or story arc!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = list.map((plot, index) => {
                const actualIndex = campaignData.plots.indexOf(plot);
                const statusColors = {
                    'Active': '#10b981',
                    'Pending': '#f59e0b',
                    'Completed': '#6366f1',
                    'Abandoned': '#64748b'
                };

                return `
                    <div class="plot-card">
                        <div class="card-header">
                            <div>
                                <div class="card-name">${plot.title}</div>
                                <div class="card-type">
                                    <span style="background: ${statusColors[plot.status]}; padding: 5px 14px; border-radius: 20px; font-size: 0.85em; font-weight: 600;">
                                        ${plot.status}
                                    </span>
                                    <span style="margin-left: 12px;">${plot.type}</span>
                                </div>
                            </div>
                            <div class="btn-group">
                                <button onclick="openPlotModal(${actualIndex})" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">✏️ Edit</button>
                                <button onclick="deletePlot(${actualIndex})" class="delete-btn">🗑️ Delete</button>
                            </div>
                        </div>
                        ${plot.description ? `<div class="notes">${plot.description.replace(/\n/g, '<br>')}</div>` : ''}
                        ${plot.characters ? `<div class="relationships"><strong>Related Characters:</strong> ${plot.characters}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Sessions
        function openSessionModal(index = null) {
            editingIndex = index;
            editingType = 'session';
            const modal = document.getElementById('session-modal');
            
            if (index !== null) {
                const session = campaignData.sessions[index];
                document.getElementById('session-number').value = session.number;
                document.getElementById('session-date').value = session.date;
                document.getElementById('session-title').value = session.title;
                document.getElementById('session-notes').value = session.notes;
            } else {
                document.getElementById('session-number').value = campaignData.sessions.length + 1;
                document.getElementById('session-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('session-title').value = '';
                document.getElementById('session-notes').value = '';
            }
            
            modal.classList.add('active');
        }

        function closeSessionModal() {
            document.getElementById('session-modal').classList.remove('active');
            editingIndex = null;
        }

        function saveSession() {
            const session = {
                number: document.getElementById('session-number').value || campaignData.sessions.length + 1,
                date: document.getElementById('session-date').value,
                title: document.getElementById('session-title').value,
                notes: document.getElementById('session-notes').value
            };

            if (editingIndex !== null) {
                campaignData.sessions[editingIndex] = session;
            } else {
                campaignData.sessions.push(session);
            }

            saveData();
            renderSessions();
            closeSessionModal();
        }

        function deleteSession(index) {
            if (confirm('Are you sure you want to delete this session?')) {
                campaignData.sessions.splice(index, 1);
                saveData();
                renderSessions();
            }
        }

        function renderSessions() {
            const container = document.getElementById('sessions-list');
            
            if (campaignData.sessions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🎲</div>
                        <h3>No Session Notes Yet</h3>
                        <p>Record your first game session!</p>
                    </div>
                `;
                return;
            }

            const sortedSessions = [...campaignData.sessions].sort((a, b) => b.number - a.number);

            container.innerHTML = sortedSessions.map((session) => {
                const index = campaignData.sessions.indexOf(session);
                return `
                    <div class="session-card">
                        <div class="card-header">
                            <div>
                                <div class="card-name">Session ${session.number}${session.title ? ': ' + session.title : ''}</div>
                                <div class="card-type">${session.date ? new Date(session.date).toLocaleDateString() : ''}</div>
                            </div>
                            <div class="btn-group">
                                <button onclick="openSessionModal(${index})" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">✏️ Edit</button>
                                <button onclick="deleteSession(${index})" class="delete-btn">🗑️ Delete</button>
                            </div>
                        </div>
                        ${session.notes ? `<div class="notes">${session.notes.replace(/\n/g, '<br>')}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Locations
        function openLocationModal(index = null) {
            editingIndex = index;
            editingType = 'location';
            const modal = document.getElementById('location-modal');
            
            if (index !== null) {
                const loc = campaignData.locations[index];
                document.getElementById('location-name').value = loc.name;
                document.getElementById('location-type').value = loc.type;
                document.getElementById('location-description').value = loc.description;
                document.getElementById('location-notes').value = loc.notes;
                
                if (loc.image) {
                    document.getElementById('location-image-preview').src = loc.image;
                    document.getElementById('location-image-preview').style.display = 'block';
                }
            } else {
                document.getElementById('location-name').value = '';
                document.getElementById('location-type').value = 'City';
                document.getElementById('location-description').value = '';
                document.getElementById('location-notes').value = '';
                document.getElementById('location-image').value = '';
                document.getElementById('location-image-preview').style.display = 'none';
            }
            
            modal.classList.add('active');
        }

        function closeLocationModal() {
            document.getElementById('location-modal').classList.remove('active');
            editingIndex = null;
        }

        function saveLocation() {
            const name = document.getElementById('location-name').value;
            if (!name) {
                alert('Please enter a location name');
                return;
            }

            const location = {
                name: name,
                type: document.getElementById('location-type').value,
                description: document.getElementById('location-description').value,
                notes: document.getElementById('location-notes').value,
                image: document.getElementById('location-image-preview').src || null
            };

            if (editingIndex !== null) {
                campaignData.locations[editingIndex] = location;
            } else {
                campaignData.locations.push(location);
            }

            saveData();
            renderLocations();
            closeLocationModal();
        }

        function deleteLocation(index) {
            if (confirm('Are you sure you want to delete this location?')) {
                campaignData.locations.splice(index, 1);
                saveData();
                renderLocations();
            }
        }

        function renderLocations(locs = null) {
            const container = document.getElementById('locations-list');
            const list = locs || campaignData.locations;
            
            if (list.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🗺️</div>
                        <h3>No Locations Yet</h3>
                        <p>Add your first location!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = list.map((loc, index) => {
                const actualIndex = campaignData.locations.indexOf(loc);
                return `
                    <div class="location-card">
                        <div class="card-header">
                            <div style="display: flex; align-items: flex-start;">
                                ${loc.image ? `<img src="${loc.image}" class="card-image" alt="${loc.name}">` : ''}
                                <div class="card-info">
                                    <div class="card-name">${loc.name}</div>
                                    <div class="card-type">${loc.type}</div>
                                </div>
                            </div>
                            <div class="btn-group">
                                <button onclick="openLocationModal(${actualIndex})" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">✏️ Edit</button>
                                <button onclick="deleteLocation(${actualIndex})" class="delete-btn">🗑️ Delete</button>
                            </div>
                        </div>
                        ${loc.description ? `<div class="notes">${loc.description.replace(/\n/g, '<br>')}</div>` : ''}
                        ${loc.notes ? `<div class="notes" style="border-top: none; padding-top: 10px;"><strong>Notable Features:</strong><br>${loc.notes.replace(/\n/g, '<br>')}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Items
        function openItemModal(index = null) {
            editingIndex = index;
            editingType = 'item';
            const modal = document.getElementById('item-modal');
            
            if (index !== null) {
                const item = campaignData.items[index];
                document.getElementById('item-name').value = item.name;
                document.getElementById('item-type').value = item.type;
                document.getElementById('item-owner').value = item.owner;
                document.getElementById('item-description').value = item.description;
                
                if (item.image) {
                    document.getElementById('item-image-preview').src = item.image;
                    document.getElementById('item-image-preview').style.display = 'block';
                }
            } else {
                document.getElementById('item-name').value = '';
                document.getElementById('item-type').value = 'Weapon';
                document.getElementById('item-owner').value = '';
                document.getElementById('item-description').value = '';
                document.getElementById('item-image').value = '';
                document.getElementById('item-image-preview').style.display = 'none';
            }
            
            modal.classList.add('active');
        }

        function closeItemModal() {
            document.getElementById('item-modal').classList.remove('active');
            editingIndex = null;
        }

        function saveItem() {
            const name = document.getElementById('item-name').value;
            if (!name) {
                alert('Please enter an item name');
                return;
            }

            const item = {
                name: name,
                type: document.getElementById('item-type').value,
                owner: document.getElementById('item-owner').value,
                description: document.getElementById('item-description').value,
                image: document.getElementById('item-image-preview').src || null
            };

            if (editingIndex !== null) {
                campaignData.items[editingIndex] = item;
            } else {
                campaignData.items.push(item);
            }

            saveData();
            renderItems();
            closeItemModal();
        }

        function deleteItem(index) {
            if (confirm('Are you sure you want to delete this item?')) {
                campaignData.items.splice(index, 1);
                saveData();
                renderItems();
            }
        }

        function renderItems(items = null) {
            const container = document.getElementById('items-list');
            const list = items || campaignData.items;
            
            if (list.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">⚔️</div>
                        <h3>No Items Yet</h3>
                        <p>Add your first item or piece of loot!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = list.map((item, index) => {
                const actualIndex = campaignData.items.indexOf(item);
                return `
                    <div class="item-card">
                        <div class="card-header">
                            <div style="display: flex; align-items: flex-start;">
                                ${item.image ? `<img src="${item.image}" class="card-image" alt="${item.name}">` : ''}
                                <div class="card-info">
                                    <div class="card-name">${item.name}</div>
                                    <div class="card-type">${item.type}${item.owner ? ' • Owned by: ' + item.owner : ''}</div>
                                </div>
                            </div>
                            <div class="btn-group">
                                <button onclick="openItemModal(${actualIndex})" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">✏️ Edit</button>
                                <button onclick="deleteItem(${actualIndex})" class="delete-btn">🗑️ Delete</button>
                            </div>
                        </div>
                        ${item.description ? `<div class="notes">${item.description.replace(/\n/g, '<br>')}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Combat Tracker
        function updateCombatantDropdown() {
            const select = document.getElementById('combatant-character');
            select.innerHTML = '<option value="">-- Manual Entry --</option>' + 
                campaignData.characters.map((char, index) => 
                    `<option value="${index}">${char.name} (${char.type})</option>`
                ).join('');
        }

        function loadCharacterStats() {
            const select = document.getElementById('combatant-character');
            const index = select.value;
            
            if (index === '') {
                document.getElementById('combatant-name').value = '';
                document.getElementById('combatant-initiative').value = '0';
                document.getElementById('combatant-hp').value = '10';
                document.getElementById('combatant-max-hp').value = '10';
                document.getElementById('combatant-ac').value = '10';
                return;
            }

            const char = campaignData.characters[index];
            document.getElementById('combatant-name').value = char.name;
            
            // Try to parse stats
            try {
                const stats = JSON.parse(char.stats);
                document.getElementById('combatant-hp').value = stats.HP || stats.hp || 10;
                document.getElementById('combatant-max-hp').value = stats.HP || stats.hp || 10;
                document.getElementById('combatant-ac').value = stats.AC || stats.ac || 10;
                document.getElementById('combatant-initiative').value = stats.Initiative || stats.initiative || stats.DEX || 0;
            } catch (e) {
                // If not JSON, leave defaults
            }
        }

        function openCombatantModal() {
            updateCombatantDropdown();
            document.getElementById('combatant-modal').classList.add('active');
        }

        function closeCombatantModal() {
            document.getElementById('combatant-modal').classList.remove('active');
        }

        function saveCombatant() {
            const name = document.getElementById('combatant-name').value;
            if (!name) {
                alert('Please enter a name');
                return;
            }

            const combatant = {
                name: name,
                initiative: parseInt(document.getElementById('combatant-initiative').value) || 0,
                hp: parseInt(document.getElementById('combatant-hp').value) || 10,
                maxHp: parseInt(document.getElementById('combatant-max-hp').value) || 10,
                ac: parseInt(document.getElementById('combatant-ac').value) || 10,
                conditions: document.getElementById('combatant-conditions').value
            };

            campaignData.combatants.push(combatant);
            campaignData.combatants.sort((a, b) => b.initiative - a.initiative);
            
            saveData();
            renderCombat();
            closeCombatantModal();
        }

        function updateCombatantHP(index, change) {
            const combatant = campaignData.combatants[index];
            combatant.hp = Math.max(0, Math.min(combatant.maxHp, combatant.hp + change));
            saveData();
            renderCombat();
        }

        function removeCombatant(index) {
            if (confirm('Remove this combatant from combat?')) {
                campaignData.combatants.splice(index, 1);
                if (campaignData.currentTurn >= campaignData.combatants.length) {
                    campaignData.currentTurn = 0;
                }
                saveData();
                renderCombat();
            }
        }

        function nextTurn() {
            if (campaignData.combatants.length === 0) return;
            
            campaignData.currentTurn++;
            if (campaignData.currentTurn >= campaignData.combatants.length) {
                campaignData.currentTurn = 0;
                campaignData.combatRound++;
            }
            
            document.getElementById('combat-round').textContent = campaignData.combatRound;
            saveData();
            renderCombat();
        }

        function clearCombat() {
            if (confirm('Clear all combatants and reset combat?')) {
                campaignData.combatants = [];
                campaignData.combatRound = 1;
                campaignData.currentTurn = 0;
                document.getElementById('combat-round').textContent = '1';
                saveData();
                renderCombat();
            }
        }

        function renderCombat() {
            const container = document.getElementById('combat-list');
            document.getElementById('combat-round').textContent = campaignData.combatRound;
            
            if (campaignData.combatants.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">⚔️</div>
                        <h3>No Combat Active</h3>
                        <p>Add combatants to start tracking initiative!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '<div class="combatant-list">' + 
                campaignData.combatants.map((combatant, index) => {
                    const hpPercent = (combatant.hp / combatant.maxHp) * 100;
                    const isActive = index === campaignData.currentTurn;
                    
                    return `
                        <div class="combatant-item ${isActive ? 'active' : ''}">
                            <div class="combatant-info">
                                <div class="combatant-name">${combatant.name} ${isActive ? '👈 TURN' : ''}</div>
                                <div class="combatant-stats">
                                    <span><strong>Initiative:</strong> ${combatant.initiative}</span>
                                    <span><strong>HP:</strong> ${combatant.hp}/${combatant.maxHp}</span>
                                    <span><strong>AC:</strong> ${combatant.ac}</span>
                                    ${combatant.conditions ? `<span>• ${combatant.conditions}</span>` : ''}
                                </div>
                                <div class="hp-bar">
                                    <div class="hp-fill" style="width: ${hpPercent}%"></div>
                                </div>
                            </div>
                            <div class="btn-group">
                                <button onclick="updateCombatantHP(${index}, -5)" class="delete-btn">-5 HP</button>
                                <button onclick="updateCombatantHP(${index}, -1)" class="delete-btn">-1 HP</button>
                                <button onclick="updateCombatantHP(${index}, 1)" style="background: linear-gradient(135deg, #10b981, #34d399);">+1 HP</button>
                                <button onclick="updateCombatantHP(${index}, 5)" style="background: linear-gradient(135deg, #10b981, #34d399);">+5 HP</button>
                                <button onclick="removeCombatant(${index})" class="delete-btn">🗑️</button>
                            </div>
                        </div>
                    `;
                }).join('') + '</div>';
        }

        // Timeline
        function openTimelineModal(index = null) {
            editingIndex = index;
            editingType = 'timeline';
            const modal = document.getElementById('timeline-modal');
            
            if (index !== null) {
                const event = campaignData.timeline[index];
                document.getElementById('timeline-date').value = event.date;
                document.getElementById('timeline-event').value = event.event;
                document.getElementById('timeline-description').value = event.description;
            } else {
                document.getElementById('timeline-date').value = '';
                document.getElementById('timeline-event').value = '';
                document.getElementById('timeline-description').value = '';
            }
            
            modal.classList.add('active');
        }

        function closeTimelineModal() {
            document.getElementById('timeline-modal').classList.remove('active');
            editingIndex = null;
        }

        function saveTimelineEvent() {
            const event = document.getElementById('timeline-event').value;
            if (!event) {
                alert('Please enter an event title');
                return;
            }

            const timelineEvent = {
                date: document.getElementById('timeline-date').value,
                event: event,
                description: document.getElementById('timeline-description').value
            };

            if (editingIndex !== null) {
                campaignData.timeline[editingIndex] = timelineEvent;
            } else {
                campaignData.timeline.push(timelineEvent);
            }

            saveData();
            renderTimeline();
            closeTimelineModal();
        }

        function deleteTimelineEvent(index) {
            if (confirm('Delete this timeline event?')) {
                campaignData.timeline.splice(index, 1);
                saveData();
                renderTimeline();
            }
        }

        function renderTimeline() {
            const container = document.getElementById('timeline-list');
            
            if (campaignData.timeline.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📅</div>
                        <h3>No Timeline Events Yet</h3>
                        <p>Add your first major campaign event!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = campaignData.timeline.map((event, index) => `
                <div class="timeline-item">
                    <div class="timeline-date">${event.date || 'Unknown Date'}</div>
                    <div class="timeline-event">${event.event}</div>
                    ${event.description ? `<div style="color: #cbd5e1; margin-top: 8px; line-height: 1.6;">${event.description}</div>` : ''}
                    <div class="btn-group" style="margin-top: 15px;">
                        <button onclick="openTimelineModal(${index})" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); padding: 8px 16px; font-size: 0.9em;">✏️ Edit</button>
                        <button onclick="deleteTimelineEvent(${index})" class="delete-btn" style="padding: 8px 16px; font-size: 0.9em;">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        // Media Gallery
        function openMediaModal(index = null) {
            editingIndex = index;
            editingType = 'media';
            const modal = document.getElementById('media-modal');
            
            // Clear temp data
            tempMediaData = null;
            tempMediaType = null;
            
            if (index !== null) {
                const media = campaignData.media[index];
                document.getElementById('media-name').value = media.name;
                document.getElementById('media-category').value = media.category;
                document.getElementById('media-description').value = media.description;
                document.getElementById('media-youtube').value = media.youtube || '';
                
                if (media.data) {
                    // Store existing media data
                    tempMediaData = media.data;
                    tempMediaType = media.type;
                    
                    document.getElementById('media-preview').innerHTML = 
                        media.type === 'video' ? 
                        `<video src="${media.data}" style="max-width: 220px; max-height: 220px; border-radius: 12px;" controls></video>` :
                        `<img src="${media.data}" style="max-width: 220px; max-height: 220px; border-radius: 12px;">`;
                }
            } else {
                document.getElementById('media-name').value = '';
                document.getElementById('media-category').value = 'Map';
                document.getElementById('media-description').value = '';
                document.getElementById('media-youtube').value = '';
                document.getElementById('media-file').value = '';
                document.getElementById('media-preview').innerHTML = '';
            }
            
            modal.classList.add('active');
        }

        function closeMediaModal() {
            document.getElementById('media-modal').classList.remove('active');
            tempMediaData = null;
            tempMediaType = null;
            editingIndex = null;
        }

        let tempMediaData = null;
        let tempMediaType = null;

        function previewMedia(input) {
            const preview = document.getElementById('media-preview');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const fileSizeMB = file.size / (1024 * 1024);
                
                // Warn about large files
                if (fileSizeMB > 10) {
                    if (!confirm(`This file is ${fileSizeMB.toFixed(1)}MB. Large files can slow down the app. Continue?`)) {
                        input.value = '';
                        return;
                    }
                }
                
                const reader = new FileReader();
                
                // Show loading message
                preview.innerHTML = '<div style="color: #60a5fa; padding: 20px;">📂 Loading file...</div>';
                
                reader.onload = function(e) {
                    tempMediaData = e.target.result;
                    tempMediaType = file.type.startsWith('video') ? 'video' : 'image';
                    
                    if (file.type.startsWith('image')) {
                        preview.innerHTML = `<img src="${e.target.result}" class="image-preview">`;
                    } else if (file.type.startsWith('video')) {
                        preview.innerHTML = `<video src="${e.target.result}" class="image-preview" controls></video>`;
                    }
                    
                    preview.innerHTML += '<div style="color: #10b981; margin-top: 10px; font-size: 0.9em;">✓ File loaded! Ready to save.</div>';
                };
                
                reader.onerror = function() {
                    preview.innerHTML = '<div style="color: #ef4444; padding: 20px;">❌ Error loading file. Try a smaller file or use a YouTube link instead.</div>';
                    tempMediaData = null;
                    input.value = '';
                };
                
                reader.readAsDataURL(file);
            }
        }

        function saveMedia() {
            const name = document.getElementById('media-name').value || 'Untitled Media';
            const youtube = document.getElementById('media-youtube').value;
            
            if (!youtube && !tempMediaData) {
                alert('Please upload a file or provide a YouTube URL');
                return;
            }

            const media = {
                name: name,
                category: document.getElementById('media-category').value,
                description: document.getElementById('media-description').value,
                youtube: youtube
            };

            if (tempMediaData) {
                media.type = tempMediaType;
                media.data = tempMediaData;
                
                if (editingIndex !== null) {
                    campaignData.media[editingIndex] = media;
                } else {
                    campaignData.media.push(media);
                }
                
                saveData();
                renderMedia();
                
                // Clear temp data
                tempMediaData = null;
                tempMediaType = null;
                
                closeMediaModal();
                
                // Show success message
                alert('✅ Media saved successfully! Click it to show fullscreen to your players.');
            } else if (youtube) {
                media.type = 'youtube';
                
                if (editingIndex !== null) {
                    campaignData.media[editingIndex] = media;
                } else {
                    campaignData.media.push(media);
                }
                
                saveData();
                renderMedia();
                closeMediaModal();
                
                alert('✅ YouTube video saved! Click it to show fullscreen to your players.');
            }
        }

        function deleteMedia(index) {
            if (confirm('Delete this media?')) {
                campaignData.media.splice(index, 1);
                saveData();
                renderMedia();
            }
        }

        function showMediaFullscreen(index) {
            const media = campaignData.media[index];
            const viewer = document.getElementById('fullscreen-viewer');
            const content = document.getElementById('fullscreen-content');
            
            if (media.youtube) {
                const videoId = media.youtube.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/)?.[1];
                content.innerHTML = `<iframe width="1280" height="720" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen style="border-radius: 12px;"></iframe>`;
            } else if (media.type === 'video') {
                content.innerHTML = `<video src="${media.data}" controls autoplay style="max-width: 90vw; max-height: 90vh; border-radius: 12px;"></video>`;
            } else {
                content.innerHTML = `<img src="${media.data}" style="max-width: 90vw; max-height: 90vh; border-radius: 12px;">`;
            }
            
            viewer.classList.add('active');
        }

        function closeFullscreen() {
            document.getElementById('fullscreen-viewer').classList.remove('active');
            document.getElementById('fullscreen-content').innerHTML = '';
        }

        function renderMedia() {
            const container = document.getElementById('media-list');
            
            if (campaignData.media.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🖼️</div>
                        <h3>No Media Yet</h3>
                        <p>Add images, maps, or videos to share with players!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = campaignData.media.map((media, index) => {
                let thumbnail = '';
                if (media.youtube) {
                    const videoId = media.youtube.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/)?.[1];
                    thumbnail = `<img src="https://img.youtube.com/vi/${videoId}/mqdefault.jpg" class="media-thumbnail">`;
                } else if (media.type === 'video') {
                    thumbnail = `<video src="${media.data}" class="media-thumbnail"></video>`;
                } else {
                    thumbnail = `<img src="${media.data}" class="media-thumbnail">`;
                }

                return `
                    <div class="media-item" onclick="showMediaFullscreen(${index})">
                        ${thumbnail}
                        <div class="media-info">
                            <div class="media-name">${media.name}</div>
                            <div class="media-category">${media.category}</div>
                            <div class="btn-group" style="margin-top: 12px;" onclick="event.stopPropagation();">
                                <button onclick="openMediaModal(${index})" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); padding: 8px 16px; font-size: 0.85em;">✏️</button>
                                <button onclick="deleteMedia(${index})" class="delete-btn" style="padding: 8px 16px; font-size: 0.85em;">🗑️</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Dice Roller
        function toggleDiceRoller() {
            const roller = document.getElementById('dice-roller');
            roller.classList.toggle('minimized');
            const btn = roller.querySelector('.close-btn');
            btn.textContent = roller.classList.contains('minimized') ? '+' : '−';
        }

        function rollDice(sides) {
            const result = Math.floor(Math.random() * sides) + 1;
            document.getElementById('dice-result').textContent = `🎲 ${result} (d${sides})`;
        }

        function rollCustomDice() {
            const input = document.getElementById('custom-dice').value;
            const match = input.match(/(\d+)d(\d+)([+-]\d+)?/i);
            
            if (!match) {
                document.getElementById('dice-result').textContent = 'Invalid format! Use: 2d6+3';
                return;
            }

            const [, numDice, sides, modifier] = match;
            let total = 0;
            let rolls = [];

            for (let i = 0; i < parseInt(numDice); i++) {
                const roll = Math.floor(Math.random() * parseInt(sides)) + 1;
                rolls.push(roll);
                total += roll;
            }

            if (modifier) {
                total += parseInt(modifier);
            }

            document.getElementById('dice-result').innerHTML = 
                `🎲 ${total}<br><small style="font-size: 0.75em; opacity: 0.9;">Rolls: [${rolls.join(', ')}]${modifier ? ' ' + modifier : ''}</small>`;
        }

        // Quick Notes
        function toggleQuickNotes() {
            const notes = document.getElementById('quick-notes');
            notes.classList.toggle('minimized');
            document.getElementById('notes-toggle').textContent = 
                notes.classList.contains('minimized') ? '▲' : '▼';
        }

        function saveQuickNotes() {
            campaignData.quickNotes = document.getElementById('quick-notes-text').value;
            saveData();
        }

        function loadQuickNotes() {
            document.getElementById('quick-notes-text').value = campaignData.quickNotes || '';
        }

        // Random Generators
        function openRandomGenerator() {
            document.getElementById('random-modal').classList.add('active');
        }

        function closeRandomModal() {
            document.getElementById('random-modal').classList.remove('active');
        }

        function generateRandom(type) {
            if (type === 'name') {
                const firstNames = ['Aldrin', 'Thora', 'Garrick', 'Elara', 'Bram', 'Lyssa', 'Torin', 'Sera', 'Magnus', 'Kira', 'Orin', 'Nessa', 'Darius', 'Vex', 'Finn', 'Mira', 'Rowan', 'Zara'];
                const lastNames = ['Ironforge', 'Stormwind', 'Shadowbane', 'Brightwood', 'Darkwater', 'Flameheart', 'Frostborn', 'Swiftblade', 'Thornhill', 'Moonshadow', 'Dragonsbane', 'Starfall', 'Ashwood', 'Silvermane'];
                
                const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
                const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
                
                document.getElementById('random-name-result').textContent = `${firstName} ${lastName}`;
            } else if (type === 'tavern') {
                const adjectives = ['Prancing', 'Drunken', 'Golden', 'Silver', 'Rusty', 'Laughing', 'Dancing', 'Sleeping', 'Roaring', 'Howling', 'Tipsy', 'Merry'];
                const nouns = ['Pony', 'Dragon', 'Mermaid', 'Griffin', 'Barrel', 'Sword', 'Crown', 'Moon', 'Lion', 'Bear', 'Stag', 'Phoenix'];
                
                const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
                const noun = nouns[Math.floor(Math.random() * nouns.length)];
                
                document.getElementById('random-tavern-result').textContent = `The ${adj} ${noun}`;
            } else if (type === 'encounter') {
                const encounters = [
                    'A mysterious hooded figure watches from the shadows',
                    'Bandits ambush the party on the road',
                    'A merchant needs urgent escort through dangerous territory',
                    'Strange magical runes glow on ancient stones',
                    'A wounded creature seeks help from the party',
                    'Local villagers report disappearances near old ruins',
                    'A traveling bard shares rumors of treasure',
                    'Cultists perform a dark ritual in the forest',
                    'A magical storm suddenly appears overhead',
                    'An old friend appears with desperate news',
                    'The party discovers a hidden underground passage',
                    'A powerful magical artifact is being auctioned',
                    'Refugees flee from an approaching threat',
                    'A noble offers a suspicious quest with great reward',
                    'Strange tracks lead into unexplored territory',
                    'A ghostly figure beckons from an abandoned building',
                    'Merchants are being extorted by a local gang',
                    'A dragon is spotted circling nearby mountains'
                ];
                
                const encounter = encounters[Math.floor(Math.random() * encounters.length)];
                document.getElementById('random-encounter-result').textContent = encounter;
            }
        }

        // Image preview helper
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Render all
        function renderAll() {
            renderCharacters();
            renderPlots();
            renderSessions();
            renderLocations();
            renderItems();
            renderCombat();
            renderTimeline();
            renderMedia();
        }
    </script>
</body>
</html>